<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>高精度答题卡识别系统</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .config-panel {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .config-panel input {
      width: 120px;
      margin: 5px;
      padding: 5px;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .start-btn { background-color: #4CAF50; color: #fff; }
    .capture-btn { background-color: #2196F3; color: #fff; }
    .stop-btn { background-color: #f44336; color: #fff; }
    .scan-save-btn { background-color: #FF9800; color: #fff; }
    .stats-btn { background-color: #9C27B0; color: #fff; }
    .export-btn { background-color: #FF9800; color: #fff; }
    .hide { display: none; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    .question-item, .aggregate-item {
      margin: 5px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .correct { color: green; }
    .incorrect { color: red; }
    @media (max-width: 600px) {
      .config-panel input { width: 80px; }
      canvas { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>答题卡扫描系统</h1>
    
    <div class="config-panel">
      <input type="number" id="questionCount" placeholder="题目总数" value="25" min="1">
      <input type="number" id="optionCount" placeholder="选项数量" value="4" min="2">
      <input type="number" id="studentIdDigits" placeholder="准考证位数" value="10" min="1">
      <input type="number" id="scorePerQuestion" placeholder="每题分值" value="2" min="1">
      <button id="generateBtn">生成模板</button>
      <button id="setAnswerKeyBtn">设置答案</button>
      <button class="export-btn" id="exportPdfBtn">导出PDF</button>
    </div>

    <div id="answerSheetContainer">
      <canvas id="answerSheetCanvas" width="595" height="842"></canvas>
    </div>

    <div id="cameraContainer" class="hide">
      <video id="cameraPreview" autoplay style="width:100%; height:400px; background:#000;"></video>
      <canvas id="captureCanvas" class="hide"></canvas>
      <div style="text-align:center; margin:10px;">
        <button class="start-btn" id="startCameraBtn">开启摄像头</button>
        <button class="capture-btn" id="captureBtn">扫描识别</button>
        <button class="stop-btn" id="stopCameraBtn">关闭摄像头</button>
      </div>
    </div>

    <div id="results" class="hide">
      <h3>识别结果</h3>
      <div>得分：<span id="totalScore">0</span></div>
      <div id="questionStats" style="column-count:2;"></div>
      <button class="scan-save-btn" id="saveResultBtn">保存结果</button>
    </div>

    <div id="aggregate" class="hide">
      <h3>统计结果</h3>
      <div id="aggregateStats"></div>
      <button class="stats-btn" id="hideAggregateBtn">关闭统计</button>
    </div>
  </div>

  <script async src="https://docs.opencv.org/4.5.3/opencv.js"></script>
  
  <script>
    "use strict";
    let videoStream = null;
    let isCameraActive = false;
    let answerKey = [];
    let studentAnswers = [];
    let allStudentResults = [];
    let optionPositions = [];

    document.addEventListener('DOMContentLoaded', () => {
      if (!navigator.mediaDevices?.getUserMedia) {
        alert("浏览器不支持摄像头功能");
        return;
      }

      document.getElementById('generateBtn').addEventListener('click', generateAnswerSheet);
      document.getElementById('setAnswerKeyBtn').addEventListener('click', setAnswerKey);
      document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
      document.getElementById('startCameraBtn').addEventListener('click', startCamera);
      document.getElementById('captureBtn').addEventListener('click', captureImage);
      document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
      document.getElementById('saveResultBtn').addEventListener('click', saveResult);
      document.getElementById('hideAggregateBtn').addEventListener('click', () => {
        document.getElementById('aggregate').classList.add('hide');
      });

      generateAnswerSheet();
    });

    function generateAnswerSheet() {
      const canvas = document.getElementById('answerSheetCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 595;
      canvas.height = 842;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 绘制基础模板
      ctx.font = "24px Arial";
      ctx.fillText("标准答题卡", 240, 40);
      
      // 记录选项位置
      optionPositions = [];
      const questionCount = parseInt(document.getElementById('questionCount').value);
      const optionCount = parseInt(document.getElementById('optionCount').value);
      const startX = 300, startY = 100, colWidth = 200;

      for (let q = 0; q < questionCount; q++) {
        const col = Math.floor(q / 25);
        const y = startY + (q % 25) * 30;
        
        for (let o = 0; o < optionCount; o++) {
          const x = startX + col * colWidth + o * 25;
          ctx.strokeRect(x, y, 15, 15);
          
          optionPositions.push({
            question: q + 1,
            option: String.fromCharCode(65 + o),
            x: x / canvas.width,
            y: y / canvas.height,
            width: 15 / canvas.width,
            height: 15 / canvas.height
          });
        }
      }
    }

    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 }
        });
        const video = document.getElementById('cameraPreview');
        video.srcObject = videoStream;
        document.getElementById('cameraContainer').classList.remove('hide');
        isCameraActive = true;
      } catch (err) {
        alert("摄像头访问失败: " + err.message);
      }
    }

    function captureImage() {
      if (!isCameraActive) return;
      
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('captureCanvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      processImage(canvas);
    }

    function processImage(canvas) {
      if (typeof cv === 'undefined') return alert("OpenCV未加载完成");

      try {
        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // 图像增强
        cv.equalizeHist(gray, gray);
        cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
        
        // 阈值处理
        let thresh = new cv.Mat();
        cv.adaptiveThreshold(gray, thresh, 255, 
          cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);

        // 形态学处理
        let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3,3));
        cv.morphologyEx(thresh, thresh, cv.MORPH_CLOSE, kernel);

        // 轮廓分析
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        studentAnswers = Array(parseInt(document.getElementById('questionCount').value))
          .fill().map(() => ({ answer: null, area: 0 }));

        const imgWidth = canvas.width;
        const imgHeight = canvas.height;

        for (let i = 0; i < contours.size(); i++) {
          const cnt = contours.get(i);
          const rect = cv.boundingRect(cnt);
          
          // 轮廓筛选
          if (rect.width < 10 || rect.height < 10) continue;
          if (rect.width * rect.height < 50) continue;

          // 位置匹配
          const centerX = rect.x + rect.width/2;
          const centerY = rect.y + rect.height/2;
          
          optionPositions.forEach(pos => {
            const xStart = pos.x * imgWidth;
            const yStart = pos.y * imgHeight;
            if (centerX > xStart && centerX < xStart + pos.width * imgWidth &&
                centerY > yStart && centerY < yStart + pos.height * imgHeight) {
              const qIndex = pos.question - 1;
              const area = rect.width * rect.height;
              if (area > studentAnswers[qIndex].area) {
                studentAnswers[qIndex] = {
                  answer: pos.option,
                  area: area
                };
              }
            }
          });
        }

        // 释放内存
        [src, gray, thresh, kernel, contours, hierarchy].forEach(m => m.delete());
        showResults();
      } catch (err) {
        console.error("图像处理错误:", err);
        alert("识别失败，请重试");
      }
    }

    function showResults() {
      const scorePer = parseInt(document.getElementById('scorePerQuestion').value);
      let total = 0;
      const results = studentAnswers.map((ans, i) => {
        const correct = ans.answer === answerKey[i];
        if (correct) total += scorePer;
        return {
          question: i+1,
          answer: ans.answer || '未作答',
          correct: correct,
          key: answerKey[i] || '未设置'
        };
      });

      document.getElementById('totalScore').textContent = total;
      document.getElementById('questionStats').innerHTML = results.map(r => `
        <div class="${r.correct ? 'correct' : 'incorrect'}">
          Q${r.question}: ${r.answer} (正确答案: ${r.key})
        </div>
      `).join('');
      document.getElementById('results').classList.remove('hide');
    }

    function setAnswerKey() {
      const count = parseInt(document.getElementById('questionCount').value);
      const input = prompt(`请输入${count}个答案（用逗号分隔）:`);
      if (input) {
        answerKey = input.toUpperCase().split(',').slice(0, count);
        alert("答案已设置");
      }
    }

    function saveResult() {
      allStudentResults.push({
        answers: studentAnswers.map(a => a.answer),
        score: parseInt(document.getElementById('totalScore').textContent)
      });
      alert(`已保存${allStudentResults.length}份结果`);
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const img = document.getElementById('answerSheetCanvas').toDataURL();
      doc.addImage(img, 'PNG', 10, 10, 190, 280);
      doc.save('answer_sheet.pdf');
    }

    function stopCamera() {
      videoStream?.getTracks().forEach(t => t.stop());
      isCameraActive = false;
      document.getElementById('cameraContainer').classList.add('hide');
    }
  </script>
</body>
</html>
